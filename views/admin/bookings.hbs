<div class="container-fluid px-4 mt-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="fw-bold text-danger m-0">Reservations</h1>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="window.location.reload()">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Search + Stats -->
  <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
    <div class="input-group" style="max-width:420px;">
      <span class="input-group-text bg-danger text-white border-danger">
        <i class="bi bi-search"></i>
      </span>
      <input type="text" id="reservationFilter" class="form-control" placeholder="Search by user, flight, status, or date...">
    </div>
    <div class="text-muted small mt-2 mt-md-0">
      Total Reservations: <span class="fw-bold">{{reservations.length}}</span>
    </div>
  </div>

  {{#if reservations.length}}
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-danger text-center">
            <tr>
              <th>User</th>
              <th>Flight</th>
              <th>Route</th>
              <th>Trip</th>
              <th>Class</th>
              <th>Passengers</th>
              <th>Date Booked</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="reservationTable">
          {{#each reservations}}
            <!-- Main Row -->
            <tr id="res-{{this._id}}" class="text-center align-middle">
              <td>
                {{this.userId.firstName}} {{this.userId.lastName}}<br>
                <small class="text-muted">{{this.userId.email}}</small>
              </td>
              <td class="fw-semibold">{{this.flight.flightNumber}}</td>
              <td>{{this.flight.origin}} → {{this.flight.destination}}</td>
              <td>{{this.tripType}}</td>
              <td>{{this.travelClass}}</td>
              <td>
                {{this.passengers.length}}
                <button class="btn btn-sm btn-outline-secondary ms-1 togglePassengers" data-id="{{this._id}}" title="View Passengers">
                  <i class="bi bi-caret-down"></i>
                </button>
              </td>
              <td>{{formatDate this.bookingDate}}</td>
              <td>
                <!-- Display mode -->
                <div class="status-display" id="statusDisplay-{{this._id}}">
                  <span class="badge
                    {{#if (eq this.status 'Confirmed')}}bg-success{{/if}}
                    {{#if (eq this.status 'Cancelled')}}bg-danger{{/if}}
                    {{#if (eq this.status 'Pending')}}bg-secondary{{/if}}">
                    {{this.status}}
                  </span>
                  <button class="btn btn-sm btn-outline-primary ms-1 editStatusBtn" data-id="{{this._id}}" title="Edit Status">
                    <i class="bi bi-pencil"></i>
                  </button>
                </div>

                <!-- Edit mode -->
                <div class="status-edit d-none" id="statusEdit-{{this._id}}">
                  <select class="form-select form-select-sm d-inline-block w-auto me-2" id="statusSelect-{{this._id}}">
                    <option value="Confirmed" {{#if (eq this.status 'Confirmed')}}selected{{/if}}>Confirmed</option>
                    <option value="Cancelled" {{#if (eq this.status 'Cancelled')}}selected{{/if}}>Cancelled</option>
                    <option value="Pending" {{#if (eq this.status 'Pending')}}selected{{/if}}>Pending</option>
                  </select>
                  <button class="btn btn-sm btn-success me-1 saveStatusBtn" data-id="{{this._id}}">
                    <i class="bi bi-check2"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-secondary cancelStatusBtn" data-id="{{this._id}}">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-danger deleteReservationBtn" data-id="{{this._id}}" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>

            <!-- Expandable Passengers Row -->
            <tr class="passengers-row d-none" id="passengers-{{this._id}}">
              <td colspan="9">
                <div class="p-3 bg-light rounded border">
                  <div class="fw-semibold mb-2">Passengers</div>
                  {{#if this.passengers.length}}
                    <div class="row row-cols-1 row-cols-md-2 g-2">
                      {{#each this.passengers}}
                        <div class="col">
                          <div class="p-2 bg-white rounded border">
                            <div><strong>Name:</strong> {{this.fullName}}</div>
                            {{#if this.age}}<div><strong>Age:</strong> {{this.age}}</div>{{/if}}
                            {{#if this.passport}}<div><strong>Passport:</strong> {{this.passport}}</div>{{/if}}
                          </div>
                        </div>
                      {{/each}}
                    </div>
                  {{else}}
                    <div class="text-muted">No passenger details available.</div>
                  {{/if}}
                </div>
              </td>
            </tr>
          {{/each}}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {{else}}
    <div class="alert alert-secondary text-center">No reservations found.</div>
  {{/if}}
</div>

 <!-- Edit Reservation Status Button -->
<div class="modal fade" id="resevationStatusModal" tabindex="-1" aria-labelledby="resevationStatusLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
        <div class="modal-body">
        <form id="statusUpdateForm" class="needs-validation" method="POST" novalidate>
            <header class="text-center">
            <h1 class="modal-title fs-5" id="resevationStatusLabel">Edit Reservation Status</h1>
            </header>
            <br>
            <div class="mb-3">
            <label for="updateStatus" class="form-label">Change Reservation Status</label>
            <select class="form-select" id="updateStatus">
                <option value="" disabled selected> --- Update Status ---</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Cancelled">Cancelled</option>
                <option value="Pending">Pending</option>
            </select>
            <div class="invalid-feedback">Enter a valid email address.</div>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-secondary float-start" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-danger float-end">Update</button>
            </div>
        </form>

        <div><p id="updateError" class="error-message text-danger mt-2"></p></div>

        </div>
    </div>
    </div>
</div>


<!-- delete toast -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-50 start-50 translate-middle">
    <div id="deleteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body">
            <form id="deleteToastForm" method="post">
                <p>Are you sure you want to delete this reservation?</p>
                <p>This will be deleted permanently from the database.</p>
                <div class="mt-2 pt-2 border-top">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="toast">Close</button>
                    <button id="deleteToastBtn" type="submit" class="btn btn-danger btn-sm float-end">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- confirmation toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
function showToast(message, success = true) {
  const toastEl = document.getElementById("toast");
  const toastBody = document.getElementById("toastBody");
  if (!toastEl || !toastBody) return;

  toastEl.classList.remove("bg-danger", "bg-success");
  toastEl.classList.add(success ? "bg-success" : "bg-danger");
  toastBody.textContent = message;

  new bootstrap.Toast(toastEl, { delay: 2500 }).show();
}

// ✅ Persist reservation search
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("reservationFilter");
  if (!input) return;

  const key = "reservation_search";
  const saved = localStorage.getItem(key);
  if (saved) {
    input.value = saved;
    input.dispatchEvent(new Event("input"));
  }
  input.addEventListener("input", () => {
    localStorage.setItem(key, input.value);
  });
});

// ✅ Toggle passengers row
document.addEventListener("click", (e) => {
  if (e.target.closest(".togglePassengers")) {
    const btn = e.target.closest(".togglePassengers");
    const id = btn.dataset.id;
    const row = document.getElementById(`passengers-${id}`);
    const icon = btn.querySelector("i");

    row.classList.toggle("d-none");
    icon.classList.toggle("bi-caret-down");
    icon.classList.toggle("bi-caret-up");
  }
});

// ✅ Inline status edit: enter edit mode
document.addEventListener("click", (e) => {
  if (e.target.closest(".editStatusBtn")) {
    const id = e.target.closest(".editStatusBtn").dataset.id;
    document.getElementById(`statusDisplay-${id}`).classList.add("d-none");
    document.getElementById(`statusEdit-${id}`).classList.remove("d-none");
  }
});

// ✅ Inline status edit: cancel
document.addEventListener("click", (e) => {
  if (e.target.closest(".cancelStatusBtn")) {
    const id = e.target.closest(".cancelStatusBtn").dataset.id;
    document.getElementById(`statusEdit-${id}`).classList.add("d-none");
    document.getElementById(`statusDisplay-${id}`).classList.remove("d-none");
  }
});

// ✅ Inline status edit: save -> POST /admin/edit-reservation/:reservationId
document.addEventListener("click", async (e) => {
  if (e.target.closest(".saveStatusBtn")) {
    const id = e.target.closest(".saveStatusBtn").dataset.id;
    const select = document.getElementById(`statusSelect-${id}`);
    const newStatus = select.value;

    try {
      const res = await fetch(`/admin/edit-reservation/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });

      const data = await res.json();

      if (res.ok && data.success) {
        // Update display badge
        const display = document.getElementById(`statusDisplay-${id}`);
        const edit = document.getElementById(`statusEdit-${id}`);
        const badge = display.querySelector(".badge");

        badge.className = "badge";
        if (newStatus === "Confirmed") badge.classList.add("bg-success");
        else if (newStatus === "Cancelled") badge.classList.add("bg-danger");
        else badge.classList.add("bg-secondary");

        badge.textContent = newStatus;

        edit.classList.add("d-none");
        display.classList.remove("d-none");

        showToast("Reservation status updated!", true);
      } else {
        showToast(data.message || "Failed to update reservation.", false);
      }
    } catch (err) {
      console.error(err);
      showToast("Server error updating reservation.", false);
    }
  }
});

// ✅ Delete reservation (POST)
document.addEventListener("click", async (e) => {
  if (e.target.closest(".deleteReservationBtn")) {
    const id = e.target.closest(".deleteReservationBtn").dataset.id;
    if (!confirm("Delete this reservation? This cannot be undone.")) return;

    try {
      const res = await fetch(`/admin/delete-reservation/${id}`, {
        method: "POST"
      });

      if (res.ok) {
        // remove both rows
        const main = document.getElementById(`res-${id}`);
        const passengers = document.getElementById(`passengers-${id}`);
        if (main) main.remove();
        if (passengers) passengers.remove();
        showToast("Reservation deleted.", true);
      } else {
        showToast("Failed to delete reservation.", false);
      }
    } catch (err) {
      console.error(err);
      showToast("Server error deleting reservation.", false);
    }
  }
});
</script>
