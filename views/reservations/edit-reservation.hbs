<main class="booking-page container-fluid my-5 px-4">
  <div class="card shadow-lg mx-auto" style="max-width: 900px;">
    <div class="card-header bg-danger text-white text-center py-3">
    {{#if outboundFlight}}
        <h3>Edit Reservation â€“ 
        {{outboundFlight.flightNumber}}
        {{#if returnFlight}} / {{returnFlight.flightNumber}}{{/if}}
        </h3>

        <!-- Outbound Flight -->
        <h2 class="route-display mb-1">
        {{outboundFlight.origin}} â†’ {{outboundFlight.destination}}
        </h2>
        <p class="flight-details mb-0">
        Departure: {{outboundFlight.departureTime}} | Arrival: {{outboundFlight.arrivalTime}}
        </p>

        <!-- Return Flight -->
        {{#if returnFlight}}
        <br>
        <h2 class="route-display mb-1">
            {{returnFlight.origin}} â†’ {{returnFlight.destination}}
        </h2>
        <p class="flight-details mb-0">
            Departure: {{returnFlight.departureTime}} | Arrival: {{returnFlight.arrivalTime}}
        </p>
        {{/if}}
    {{else}}
        <h3>Edit Reservation</h3>
        <p>No flight details available.</p>
    {{/if}}
    </div>




    <!-- Reservation Info -->
    <div class="alert alert-danger text-center fw-semibold mt-3">
      <strong>Note :</strong> You can modify passenger info, meals, baggage, and seats.
      <br><small class="text-muted">(Flight and date are locked for this reservation)</small>
    </div>

    <div class="card-body">
        <form id="editReservationForm" method="POST" action="/reservations/{{reservation._id}}/edit">
            <input type="hidden" name="reservationId" value="{{reservation._id}}">
            {{#if outboundFlight}}
                <input type="hidden" name="flight" value="{{outboundFlight._id}}">
            {{/if}}
            {{#if returnFlight}}
                <input type="hidden" name="returnFlight" value="{{returnFlight._id}}">
            {{/if}}

<input type="hidden" name="totalPrice" id="totalPriceInput">
<input type="hidden" name="passengersJSON" id="passengersJSON">


            <!-- Passenger Cards -->
            <div id="passengerFields">
  {{#each reservation.passengers}}
  <div class="card my-3 shadow-sm">
    <div class="card-header bg-light"><strong>Passenger {{inc @index}}</strong></div>
    <div class="card-body">

      <!-- Row 1: Full Name + Gender -->
      <div class="row mb-2">
        <div class="col-md-6">
          <label class="form-label text-muted fw-semibold">Full Name</label>
          <input type="text" 
                 name="passengers[{{@index}}][fullName]" 
                 class="form-control" 
                 value="{{this.fullName}}" 
                 readonly
                 style="background-color: #e9ecef; color: #6c757d; cursor: not-allowed;">
        </div>
        <div class="col-md-6">
          <label class="form-label text-muted fw-semibold">Gender</label>
          <select name="passengers[{{@index}}][gender]" 
                  class="form-select" 
                  disabled 
                  style="background-color: #e9ecef; color: #6c757d; cursor: not-allowed;">
            <option value="Male" {{#if (eq this.gender "Male")}}selected{{/if}}>Male</option>
            <option value="Female" {{#if (eq this.gender "Female")}}selected{{/if}}>Female</option>
            <option value="Other" {{#if (eq this.gender "Other")}}selected{{/if}}>Other</option>
          </select>
        </div>
      </div>

      <!-- Row 2: Age + Passport -->
      <div class="row mb-2">
        <div class="col-md-6">
          <label class="form-label text-muted fw-semibold">Age</label>
          <input type="number" 
                 name="passengers[{{@index}}][age]" 
                 class="form-control" 
                 value="{{this.age}}" 
                 readonly
                 style="background-color: #e9ecef; color: #6c757d; cursor: not-allowed;">
        </div>
        <div class="col-md-6">
          <label class="form-label text-muted fw-semibold">Passport Number</label>
          <input type="text" 
                 name="passengers[{{@index}}][passport]" 
                 class="form-control" 
                 value="{{this.passport}}" 
                 readonly
                 style="background-color: #e9ecef; color: #6c757d; cursor: not-allowed;">
        </div>
      </div>

                    <!-- Row 3: Meal + Baggage -->
                    <div class="row">
                        <div class="col-md-6">
                        <label class="form-label">Meal Option</label>
                        <select name="passengers[{{@index}}][meal]" class="form-select meal-option" data-index="{{@index}}">
                            <option value="None" {{#if (eq this.meal "None")}}selected{{/if}}>None</option>
                            <option value="Vegetarian" {{#if (eq this.meal "Vegetarian")}}selected{{/if}}>Vegetarian</option>
                            <option value="Non-Vegetarian" {{#if (eq this.meal "Non-Vegetarian")}}selected{{/if}}>Non-Vegetarian</option>
                            <option value="Vegan" {{#if (eq this.meal "Vegan")}}selected{{/if}}>Vegan</option>
                            <option value="Gluten-Free" {{#if (eq this.meal "Gluten-Free")}}selected{{/if}}>Gluten-Free</option>
                        </select>
                        </div>
                        <div class="col-md-6">
                        <label class="form-label">Baggage (kg)</label>
                        <input type="number" class="form-control baggage-input" data-index="{{@index}}" name="passengers[{{@index}}][baggageAllowance]" value="{{this.baggageAllowance}}" min="0">
                        </div>
                    </div>

                    <div class="mt-2 text-muted small seat-info">Seat: {{this.seatNumber}}</div>
                    </div>
                </div>
                {{/each}}

            </div>

            <!-- Seat Selection Section -->
            <h5 class="text-center text-danger mt-4">Seat Selection</h5>
            <div id="seat-map" class="my-3 d-flex flex-wrap justify-content-center"></div>

            <!-- Legend -->
            <div class="d-flex justify-content-center gap-2 mb-3 flex-wrap">
            <span class="badge bg-danger">First Class</span>
            <span class="badge bg-light text-dark border border-purple">Business</span>
            <span class="badge bg-primary">Economy</span>
            <span class="badge bg-secondary">Occupied</span>
            <span class="badge bg-warning text-dark">Selected</span>
            </div>

            <!-- Price Summary -->
            <div class="card bg-light p-3 mb-4 summary-card mx-auto">
            <h5 class="text-danger fw-bold">Updated Price Summary</h5>

            <p>Base Fare: â‚±<span id="baseFare" data-fare="{{outboundFlight.price}}">{{outboundFlight.price}}</span></p>
            {{#if returnFlight}}
            <p>Return Fare: â‚±<span id="returnFare" data-fare="{{returnFlight.price}}">{{returnFlight.price}}</span></p>
            {{/if}}

            <p>Meal Total: â‚±<span id="mealFee">0</span></p>
            <p>Baggage Total: â‚±<span id="baggageFee">0</span></p>
            <p>Seat Total: â‚±<span id="seatFee">0</span></p>
            <hr>
            <h5>Total: â‚±<span id="totalPrice">{{reservation.totalPrice}}</span></h5>
            </div>


            <div id="formMessage" class="text-danger mb-3"></div>

            <div class="d-flex justify-content-center gap-2">
            <button type="submit" class="btn btn-danger px-4">Save Changes</button>
            <a href="/reservations/my-bookings" class="btn btn-outline-secondary px-4">Cancel</a>
            </div>
        </form>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("ðŸ§© Edit Reservation Script Loaded");

  const mealPrice = 150;
  const bagPrice  = 50;
  const seatPricing = { first: 5000, business: 3000, economy: 1500 };
  const seatClasses = { 1: "first", 2: "first", 3: "business", 4: "business" };

  // Fare elements (keep references so we can set text later)
  const baseFareEl   = document.querySelector("#baseFare");
  const returnFareEl = document.querySelector("#returnFare");

  // Build passengers model from existing cards
  const passengers = Array.from(document.querySelectorAll("#passengerFields .card")).map(card => ({
    seat:     card.querySelector(".seat-info").textContent.replace("Seat: ", "").trim(),
    meal:     card.querySelector(".meal-option").value,
    baggage:  parseInt(card.querySelector(".baggage-input").value) || 0
  }));

  // Seat map (unchanged from yours)
  const occupiedSeats = {{{occupiedSeats}}} || [];
  const seatMap = document.querySelector("#seat-map");
  seatMap.innerHTML = "";

  for (let row = 1; row <= 10; row++) {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("seat-row");
    rowDiv.style.display = "flex";
    rowDiv.style.justifyContent = "center";
    rowDiv.style.marginBottom = "8px";

    ["A", "B", "C", "D", "E", "F"].forEach((col, index) => {
      const seatId = `${row}${col}`;
      const seatClass = seatClasses[row] || "economy";
      const isOccupied = occupiedSeats.includes(seatId);
      const isSelected = passengers.some(p => p.seat === seatId);

      const seat = document.createElement("div");
      seat.classList.add("seat");
      seat.textContent  = seatId;
      seat.dataset.id   = seatId;
      seat.dataset.price= seatPricing[seatClass];
      seat.dataset.class= seatClass;

      if (isOccupied) seat.classList.add("occupied");
      else seat.classList.add(seatClass, "available");
      if (isSelected) seat.classList.add("selected");

      seat.addEventListener("click", () => {
        if (seat.classList.contains("occupied")) return alert("âš ï¸ Seat already taken!");

        if (seat.classList.contains("selected")) {
          seat.classList.remove("selected");
          const idx = passengers.findIndex(p => p.seat === seatId);
          if (idx !== -1) {
            passengers[idx].seat = null;
            document.querySelectorAll("#passengerFields .seat-info")[idx].textContent = "Seat: None";
          }
          updateSummary();
          return;
        }

        const next = passengers.findIndex(p => !p.seat);
        if (next === -1) return alert("All passengers already have seats!");

        passengers[next].seat = seatId;
        seat.classList.add("selected");
        document.querySelectorAll("#passengerFields .seat-info")[next].textContent = `Seat: ${seatId}`;
        updateSummary();
      });

      rowDiv.appendChild(seat);
      if (index === 2) {
        const gap = document.createElement("div");
        gap.style.width = "60px";
        rowDiv.appendChild(gap);
      }
    });

    seatMap.appendChild(rowDiv);
  }

  // Listeners for meal/baggage
  document.querySelectorAll(".meal-option").forEach((sel, i) => {
    sel.addEventListener("change", e => {
      passengers[i].meal = e.target.value;
      updateSummary();
    });
  });

  document.querySelectorAll(".baggage-input").forEach((inp, i) => {
    inp.addEventListener("input", e => {
      passengers[i].baggage = parseInt(e.target.value) || 0;
      updateSummary();
    });
  });

  // ---- Summary ----
  function readFare(selector) {
    const el = document.querySelector(selector);
    if (!el) return 0;
    // prefer data-fare; fallback to text content; strip non-digits just in case
    const raw = el.dataset.fare ?? el.textContent ?? "0";
    const num = parseInt(String(raw).replace(/[^\d]/g, ""), 10);
    return isNaN(num) ? 0 : num;
  }

  function getSeatClass(seatId) {
    const row = parseInt(seatId, 10);
    return seatClasses[row] || "economy";
  }

  function updateSummary() {
    const base  = readFare("#baseFare");
    const ret   = readFare("#returnFare");

    const mealFee = passengers.reduce((t, p) => t + (p.meal && p.meal !== "None" ? mealPrice : 0), 0);
    const bagFee  = passengers.reduce((t, p) => t + ((p.baggage || 0) * bagPrice), 0);
    const seatFee = passengers.reduce((t, p) => t + (p.seat ? seatPricing[getSeatClass(p.seat)] : 0), 0);

    const total = base + ret + mealFee + bagFee + seatFee;

    if (baseFareEl)   baseFareEl.textContent   = base;
    if (returnFareEl) returnFareEl.textContent = ret;
    document.querySelector("#mealFee").textContent    = mealFee;
    document.querySelector("#baggageFee").textContent = bagFee;
    document.querySelector("#seatFee").textContent    = seatFee;
    document.querySelector("#totalPrice").textContent = total;
  }

  // ðŸ‘‰ Wait for DOM hydration to complete before first calculation
setTimeout(() => {
  updateSummary();
}, 100);


// ðŸ§¾ Before submitting, collect all passenger + price data
document.querySelector("#editReservationForm").addEventListener("submit", e => {
  const totalPrice = document.querySelector("#totalPrice").textContent.trim();
  document.querySelector("#totalPriceInput").value = totalPrice;

  const passengerData = Array.from(document.querySelectorAll("#passengerFields .card")).map((card, i) => ({
    fullName: card.querySelector('input[name*="[fullName]"]').value,
    gender: card.querySelector('select[name*="[gender]"]').value,
    age: parseInt(card.querySelector('input[name*="[age]"]').value) || 0,
    passport: card.querySelector('input[name*="[passport]"]').value,
    seatNumber: card.querySelector(".seat-info").textContent.replace("Seat:", "").trim(),
    meal: card.querySelector(".meal-option").value,
    baggageAllowance: parseInt(card.querySelector(".baggage-input").value) || 0
  }));

  document.querySelector("#passengersJSON").value = JSON.stringify(passengerData);
});


});


</script>
