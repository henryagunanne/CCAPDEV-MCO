<div class="container mt-5">
  <h2>My Bookings</h2>

  {{#if reservation.length}}
      <br>
      <h5>Upcoming Bookings</h5>
      <hr>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-danger text-center">
            <tr>
              <th>Flight</th>
              <th>Routes</th>
              <th>Trip</th>
              <th>Class</th>
              <th>Passengers</th>
              <th>Date Booked</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody id="upComingBookingTable">
            {{#each reservation}}
              {{if (and (ne this.status 'Cancalled') (this.))}}
                <tr id="reservation-{{this._id}}" class="text-center align-middle">
                  <td class="fw-semibold">
                  {{#each this.flight}}
                    {{this.flightNumber}}<br>
                  {{/each}}
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-secondary ms-1 toggleRoute" data-id="{{this._id}}" title="View Route">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>
                  <td>{{this.tripType}}</td>
                  <td>{{this.travelClass}}</td>
                  <td>
                    {{this.passengers.length}}
                      <button class="btn btn-sm btn-outline-secondary ms-1 togglePassengers" data-id="{{this._id}}" title="View Passengers">
                        <i class="bi bi-eye"></i>
                      </button>
                  </td>
                  <td>{{formatDate this.bookingDate}}</td>
                  <td>
                    <div class="status-display" id="statusDisplay-{{this._id}}">
                      <span class="badge
                        {{#if (eq this.status 'Confirmed')}}bg-success{{/if}}
                        {{#if (eq this.status 'Cancelled')}}bg-danger{{/if}}
                        {{#if (eq this.status 'Pending')}}bg-secondary{{/if}}">
                        {{this.status}}
                      </span>
                    </div>
                  </td>
                  <td>
                    <a href="/reservations/edit/{{this._id}}" class="btn btn-sm btn-outline-primary me-1" title="Edit">
                    <i class="bi bi-pencil"></i>
                    <a href="#" data-id="{{this._id}}" class="btn btn-sm btn-outline-danger cancelReservation">Cancel</a>
                  </td>
                </tr>

                <!-- Expandable Route Row -->
                <tr class="route-row d-none" id="route-{{this._id}}">
                  <td colspan="9">
                    <div class="p-3 bg-light rounded border">
                      <div class="fw-semibold mb-2">Routes</div>
                      {{#if this.flight.length}}
                        <div class="row row-cols-1 row-cols-md-2 g-2">
                          {{#each this.flight}}
                            <div class="col">
                              <div class="p-2 bg-white rounded border">
                                <div><strong>Flight Number:</strong> {{this.flightNumber}}</div>
                                <div><strong>Route:</strong> {{this.origin}} → {{this.destination}}</div>
                                <div><strong>Aircraft:</strong> {{this.aircraft}}</div>
                                <div><strong>Depart On:</strong> {{this.departureDate}}</div>
                                <div><strong>Departure:</strong> {{this.departureTime}}</div>
                                <div><strong>Arrival:</strong> {{this.arrivalTime}}</div>
                              </div>
                            </div>
                          {{/each}}
                        </div>
                      {{else}}
                        <div class="text-muted">No passenger details available.</div>
                      {{/if}}
                    </div>
                  </td>
                </tr>

                <!-- Expandable Passengers Row -->
                <tr class="passengers-row d-none" id="passengers-{{this._id}}">
                  <td colspan="9">
                    <div class="p-3 bg-light rounded border">
                      <div class="fw-semibold mb-2">Passengers</div>
                      {{#if this.passengers.length}}
                        <div class="row row-cols-1 row-cols-md-2 g-2">
                          {{#each this.passengers}}
                            <div class="col">
                              <div class="p-2 bg-white rounded border">
                                <div><strong>Name:</strong> {{this.fullName}}</div>
                                <div><strong>Age:</strong> {{this.age}}</div>
                                <div><strong>Gender:</strong> {{this.gender}}</div>
                                <div><strong>Passport:</strong> {{this.passport}}</div>
                                <div><strong>Seat:</strong> {{this.seatNumber}}</div>
                                <div><strong>Meal:</strong> {{this.meal}}</div>
                                <div><strong>Baggage:</strong> {{this.baggageAllowance}}</div>
                              </div>
                            </div>
                          {{/each}}
                        </div>
                      {{else}}
                        <div class="text-muted">No passenger details available.</div>
                      {{/if}}
                    </div>
                  </td>
                </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
  {{else}}
    <div class="alert alert-info mt-4">You have no upcoming bookings yet.</div>
  {{/if}}
</div>

<!-- confirmation toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>


<script>
  function showToast(message, success = true) {
    const toastEl = document.getElementById("toast");
    const toastBody = document.getElementById("toastBody");
    if (!toastEl || !toastBody) return;

    toastEl.classList.remove("bg-danger", "bg-success");
    toastEl.classList.add(success ? "bg-success" : "bg-danger");
    toastBody.textContent = message;

    new bootstrap.Toast(toastEl, { delay: 2500 }).show();
  }

  // ✅ Toggle passengers row
  document.addEventListener("click", (e) => {
    if (e.target.closest(".togglePassengers")) {
      const btn = e.target.closest(".togglePassengers");
      const id = btn.dataset.id;
      const row = document.getElementById(`passengers-${id}`);
      const icon = btn.querySelector("i");

      row.classList.toggle("d-none");
      icon.classList.toggle("bi-eye");
      icon.classList.toggle("bi-eye-slash");
    }
  });

  // ✅ Toggle route row
  document.addEventListener("click", (e) => {
    if (e.target.closest(".toggleRoute")) {
      const btn = e.target.closest(".toggleRoute");
      const id = btn.dataset.id;
      const row = document.getElementById(`route-${id}`);
      const icon = btn.querySelector("i");

      row.classList.toggle("d-none");
      icon.classList.toggle("bi-eye");
      icon.classList.toggle("bi-eye-slash");
    }
  });
</script>